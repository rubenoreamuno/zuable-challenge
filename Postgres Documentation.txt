Primero, creamos una maquina virtual, en este caso usaremos Google Cloud Compute Engine.
En la terminal corremos el comando:
gcloud compute instances create zubale

gcloud compute ssh zubale

Ahora instalamos docker, para crear una instancia de PostgreSQL corriendo en la VM.

sudo su
apt update
apt install docker.io -y

sudo docker run --name zubale-db \
-e POSTGRES_USER=ruben \
-e POSTGRES_PASSWORD=1234 \
-e POSTGRES_DB=zubale-db \
-d -p 5432:5432 postgres


Validamos que se esté corriendo la imagen de docker.
docker images

Autenticarse y correr este firewall para permitir tcp en el puerto 5432
gcloud compute firewall-rules create allow-postgres --allow=tcp:5432

Crear la base de datos de PostgreSQL con el contenedor corriendo.
sudo docker exec -it zubale-db psql -U ruben -d zubale-db

CREATE DATABASE zubale;

Traemos los archivos csv que están previamente guardados en un bucket de GCS.
gsutil cp gs://zubale/zubale-orders.csv orders.csv
gsutil cp gs://zubale/zubale-products.csv products.csv

# Copiar directo al contenedor.
sudo docker cp products.csv zubale-db:/products.csv
sudo docker cp orders.csv zubale-db:/orders.csv


Entramos a la base de datos.
sudo docker exec -it zubale-db psql -U ruben -d zubale


Usar el DDL para crear las tablas.
CREATE TABLE products (
    id INT PRIMARY KEY,
    name TEXT,
    category TEXT,
    price NUMERIC
);

CREATE TABLE orders (
    id INT PRIMARY KEY,
    product_id INT,
    quantity INT,
    created_date TEXT
);


Verificar la creación correcta de las tablas
\dt


Insertar los datos del CSV en la tabla
\COPY products FROM '/products.csv' DELIMITER ',' CSV HEADER;
\COPY orders FROM '/orders.csv' DELIMITER ',' CSV HEADER;


Extraer los puntos solicitados.
Se utilizan indexaciones para optimizar los queries.
Se limitan las salidas del query para optimizar los recursos.

1.	The date with max amount of orders

CREATE INDEX idx_orders_created_date ON orders(created_date);

SELECT created_date
FROM orders
GROUP BY created_date
ORDER BY COUNT(*) DESC
LIMIT 1;

2.	The most demanded product

CREATE INDEX idx_orders_product_id ON orders(product_id);
CREATE INDEX idx_products_id ON products(id);  -- normalmente ya es PRIMARY KEY

SELECT p.name
FROM orders o
JOIN products p ON o.product_id = p.id
GROUP BY p.name
ORDER BY SUM(o.quantity) DESC
LIMIT 1;



3.	The top 3 most demanded categories

CREATE INDEX idx_products_category ON products(category);

SELECT p.category, SUM(o.quantity) AS total_quantity
FROM orders o
JOIN products p ON o.product_id = p.id
GROUP BY p.category
ORDER BY total_quantity DESC
LIMIT 3;



